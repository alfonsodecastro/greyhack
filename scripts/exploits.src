// Cargamos la librería de exploits
metaxploit = include_lib("/lib/metaxploit.so")
if not metaxploit then metaxploit = include_lib(current_path+"/metaxploit.so")
if not metaxploit then exit("no encuentro la librería  metaxploit.so")

//Ya tenemos metaexploit, vamos con los parámetros
if params.len < 2 or params.len > 3 then exit("
Uso: exploit dir ip [port]
	Exploit = directorio donde escribir el fichero de vulnerabilidades
	ip = Dirección IP de la máquina objetivo
	port = puerto de la máquina objetivo
	")
	
dirFichero = params[0]
if params.len == 2 then 
	source = params[1]
	puerto = 0
else
	source = params[1]
	puerto = params[2].to_int
end if


// Creamos sesión y cargamos la librería a reventar
net_session = metaxploit.net_use(source, puerto)
metaLib = net_session.dump_lib

//Creamos un fichero para guardar los BOs
nombreFichero = "BO-" + metaLib.lib_name + "-" + metaLib.version + ".txt"
// Buscamos el fichero
fichero = get_shell.host_computer.File(dirFichero + nombreFichero)
//si existe,lo borramos
if fichero then fichero.delete
// creamos el fichero vacio
get_shell.host_computer.touch(dirFichero,nombreFichero)
fichero = get_shell.host_computer.File(dirFichero + nombreFichero)

// Mostramos la info y la guardamos en s para escribirlo en el fichero
print(metaLib.lib_name + " v" + metaLib.version)
s=metaLib.lib_name + " v" + metaLib.version + "\n"
// Buscamos direcciones y exploits en esas direcciones
direcs = metaxploit.scan(metaLib)
for dir in direcs
	print("Dir: "+ dir + "\n")
	s=s+"Dir: " + dir + "\n"
	expl = metaxploit.scan_address(metaLib,dir)
	print(expl)
	s=s+expl
end for
fichero.set_content(s)
